A memory corruption vulnerability in Polkit’s, which allows any unprivileged user to gain full root privileges on a vulnerable system using default polkit configuration.

Polkit's pkexec is a SUID-root program that is installed by default on every major Linux distribution:

"Polkit (formerly PolicyKit) is a component for controlling system-wide privileges in Unix-like operating systems. It provides an organized way for non-privileged processes to communicate with privileged ones.
It is also possible to use polkit to execute commands with elevated privileges using the command pkexec followed by the command intended to be executed (with root permission)." (Wikipedia)

This vulnerability is an attacker's dream come true:

- pkexec is installed by default on all major Linux distributions (exploitable in Ubuntu, Debian, Fedora, CentOS, and other distributions are probably also exploitable);

- pkexec is vulnerable since its creation, in May 2009 (commit c8c3d83, "Add a pkexec(1) command");

- any unprivileged local user can exploit this vulnerability to obtain full root privileges;

- although this vulnerability is technically a memory corruption, it is exploitable instantly, reliably, in an architecture-independent way;

- and it is exploitable even if the polkit daemon itself is not running.

In effect, when you try to perform an action which requires a higher level of privileges, Polkit can be used to determine whether you have the requisite permissions (like UAC on windows). It is integrated with systemd and is much more configurable than the traditional sudo system. Indeed, it is sometimes referred to as the "sudo of systemd", providing a granular system with which to assign permissions to users.

When interacting with polkit we can use the `pkexec` utility — it is this program that contains the Pwnkit vulnerability. As an example of using the utility, attempting to run the `useradd` command through `pkexec` in a GUI session results in a pop-up asking for credentials.

In a CLI session, we get a text-based prompt instead:

```bash
$ pkexec useradd test1234 
==== AUTHENTICATING FOR org.freedesktop.policykit.exec === 
Authentication is needed to run '/usr/sbin/useradd' as the super user 
Authenticating as: muiri,,, (muiri) 
Password:
```

The short version is this: versions of pkexec released prior to the patch don't handle command-line arguments safely, which leads to an "out-of-bounds write" vulnerability, allowing an attacker to manipulate the environment with which pkexec is run.

More specifically, pkexec attempts to parse any command-line arguments that we pass it using a for-loop, starting at an index of 1 to offset the name of the program and obtain the first real argument (e.g. if we entered `pkexec bash`, then as `pkexec` is the name of the program, it would be argument 0 — the actual command-line arguments start at index 1). The name of the program is irrelevant to argument parsing, so the indexing is simply offset to ignore it.

What happens, then, if we don't provide any arguments? The index is set _permanently_ to 1!

The following pseudocode may help you to visualise this:

```bash
for(n=1; n < number_of_arguments; n++){ //Do Stuff }
```

If the number of arguments is 0 then `n` is _always_ less than the number of arguments. As such, `n` stays equal to one and the loop is bypassed completely.

This becomes a problem later when pkexec attempts to write to the value of the argument at index `n`. As there are no command-line arguments, there _is_ no argument at index `n` — instead the program overwrites the next thing in memory, which just so happens to be the first value in the list of environment variables when the program is called using a C function called `execve()`. In other words, by passing pkexec a null list of arguments, we can force it to overwrite an environment variable instead!  

For context: certain "dangerous" environment variables are removed by the operating system when you attempt to run a program that has the [SUID bit](https://muirlandoracle.co.uk/2020/03/05/unix-file-permissions/#SUID) set (as pkexec does by necessity); this is to prevent attackers from being able to hijack the program as it runs with administrative permissions. Using the out-of-bounds write, we are able to re-introduce our choice of these dangerous environment variables by tricking pkexec into adding it for us. There are a variety of different ways to abuse this, all leading to code execution as the root user.

## POCs - Exploitation

### [arthepsy](https://github.com/arthepsy/CVE-2021-4034)

This variation of the exploit is written in C and makes use of the dangerous `GCONV_PATH` variable to include a malicious shared object file that calls the `/bin/sh` shell with root permissions.

https://github.com/moloch--/poc-cve-2021-4034

## Mitigation
Ubuntu has already pushed updates for polkit to address the vulnerability in versions [14.04 and 16.04 ESM](https://ubuntu.com/security/notices/USN-5252-2) (extended security maintenance) as well as in more [recent versions](https://ubuntu.com/security/notices/USN-5252-1) 18.04, 20.04, and 21.04. Users just need to run a standard system update and then reboot the computer for the changes to take effect.

Red Hat has also delivered a [security update for polkit](https://access.redhat.com/security/security-updates/#/?q=polkit&p=1&sort=portal_publication_date%20desc&rows=10&portal_advisory_type=Security%20Advisory&documentKind=PortalProduct) on Workstation and on Enterprise products for supported architectures, as well as for extended life cycle support, TUS, and AUS.

A temporary mitigation for operating systems that have yet to push a patch is to use the following command to strip pkexec of the setuid bit:

```
chmod 0755 /usr/bin/pkexec
```

Users that want to look for signs of PwnKit exploitation can do it by checking the logs for either “_The value for the SHELL variable was not found the /etc/shells file_” or “_The value for environment variable […] contains suspicious content_.” entries.

However, Qualys notes that exploiting PwnKit is possible [without leaving a trace](https://github.com/Ayrx/CVE-2021-4034). 

If the exploit returns the `pkexec` help menu then the system is patched.

## Red Hat
[CVE-2021-40340 | Red Hat](https://access.redhat.com/security/cve/CVE-2021-4034)